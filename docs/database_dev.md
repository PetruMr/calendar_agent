# Progettazione database

Dato il nostro diagramma E/R, andiamo a definire le tabelle del database PostgreSQL che andremo ad utilizzare per la nostra applicazione di scheduling delle chiamate HR.

## Tabelle del database

### 1. `users`

Questa tabella conterrà le informazioni degli utenti che possono essere reclutatori o partecipanti alle chiamate.

```sql
create table public.users (
  id bigint generated by default as identity not null,
  nome text not null,
  email text not null,
  password text null,
  salt text null,
  tipo text not null default 'esterno'::text,
  username text null,
  constraint users_pkey primary key (id),
  constraint users_email_key unique (email)
) TABLESPACE pg_default;
```

Vi sarà poi la tabella `user_oauth_tokens` per gestire i token OAuth degli utenti:

```sql
create table public.user_oauth_tokens (
  id bigserial not null,
  user_id bigint null,
  provider text not null,
  access_token text null,
  refresh_token text null,
  scope text null,
  token_type text null,
  expiry_date bigint null,
  created_at timestamp with time zone not null default now(),
  updated_at timestamp with time zone not null default now(),
  constraint user_oauth_tokens_pkey primary key (id),
  constraint user_oauth_tokens_user_id_provider_key unique (user_id, provider),
  constraint user_oauth_tokens_user_id_fkey foreign KEY (user_id) references users (id) on update CASCADE on delete CASCADE
) TABLESPACE pg_default;

create trigger trg_user_oauth_tokens_updated BEFORE
update on user_oauth_tokens for EACH row
execute FUNCTION set_updated_at ();
```

### 2. `calls`

Questa tabella conterrà le informazioni sulle chiamate organizzate.

```sql
create table public.calls (
  id bigint generated by default as identity not null,
  data_creazione timestamp with time zone not null default now(),
  data_call timestamp without time zone null,
  data_deadline timestamp without time zone null,
  stato_avanzamento text null,
  tipo text null,
  durata bigint null,
  note text null,
  link_meet text null,
  titolo text null,
  constraint calls_pkey primary key (id)
) TABLESPACE pg_default;
```

### 3. `users_calls`

Questa tabella rappresenta la relazione tra gli utenti e le chiamate, permettendo di associare più utenti a più chiamate.

```sql
create table public.users_calls (
  call_id bigint not null,
  user_id bigint not null,
  calendario boolean not null default false,
  stato text null,
  token text null,
  created_at timestamp with time zone null default now(),
  lastmail_sent_at timestamp with time zone null,
  mails_sent bigint null default '0'::bigint,
  constraint participants_pkey primary key (call_id, user_id),
  constraint participants_call_id_fkey foreign KEY (call_id) references calls (id) on update CASCADE on delete CASCADE,
  constraint participants_user_id_fkey foreign KEY (user_id) references users (id) on update CASCADE on delete CASCADE
) TABLESPACE pg_default;
```

Definisce diversi dati utili che servono in particolar modo a chi non ha collegato il proprio account a Google Calendar:

### `disponibilita`

Infine abbiamo le disponibilità che vengono date da chi partecipa alla chiamata e che non hanno un account Google Calendar collegato.

```sql
create table public.users_calls (
  call_id bigint not null,
  user_id bigint not null,
  calendario boolean not null default false,
  stato text null,
  token text null,
  created_at timestamp with time zone null default now(),
  lastmail_sent_at timestamp with time zone null,
  mails_sent bigint null default '0'::bigint,
  constraint participants_pkey primary key (call_id, user_id),
  constraint participants_call_id_fkey foreign KEY (call_id) references calls (id) on update CASCADE on delete CASCADE,
  constraint participants_user_id_fkey foreign KEY (user_id) references users (id) on update CASCADE on delete CASCADE
) TABLESPACE pg_default;
```

